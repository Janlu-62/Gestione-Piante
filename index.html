<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Piante</title>
    <!-- Tailwind CSS per uno stile moderno e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts per un font pi√π gradevole -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- FIREBASE SDK v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            getDocs, 
            deleteDoc, 
            onSnapshot,
            updateDoc 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // CONFIGURAZIONE FIREBASE 
        const firebaseConfig = {
            apiKey: "AIzaSyD_3SkaVkihZCHyt6HDKDAkBcmprclr1z8",
            authDomain: "gestione-piante.firebaseapp.com",
            projectId: "gestione-piante",
            storageBucket: "gestione-piante.firebasestorage.app",
            messagingSenderId: "146683423213",
            appId: "1:146683423213:web:945c31b12d105c72451fe4"
        };

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Rendi disponibile globalmente
        window.firebaseDb = db;
        window.firebaseOperations = {
            collection,
            doc,
            setDoc,
            getDocs,
            deleteDoc,
            onSnapshot,
            updateDoc
        };
    </script>

    <style>
        /* Stile personalizzato usando il font Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Stile per nascondere le frecce dell'input date su alcuni browser */
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }
        /* Indicatore di sincronizzazione */
        .sync-indicator {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        /* Stile per i badge di stato */
        .status-badge {
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-weight: 500;
        }
        .status-late {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        .status-today {
            background-color: #fef3c7;
            color: #92400e;
        }
        .status-soon {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .status-ok {
            background-color: #d1fae5;
            color: #065f46;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-start justify-center p-4 sm:p-6">

    <div class="w-full max-w-2xl mx-auto">
        
        <!-- Titolo Principale con Indicatore di Sync -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-green-700">Gestione Piante</h1>
            <p class="text-gray-500 mt-2">Tieni traccia di annaffiature e concimazioni.</p>
            <div id="sync-status" class="mt-3 text-sm">
                <span id="sync-indicator" class="inline-flex items-center text-green-600">
                    <svg class="sync-indicator w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span id="sync-text">Sincronizzato con il cloud</span>
                </span>
            </div>
        </header>

        <!-- Sezione Promemoria -->
        <div id="reminders-section" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg mb-6">
            <h3 class="text-lg font-semibold text-yellow-800 mb-2">üìÖ Promemoria</h3>
            <div id="reminders-list" class="space-y-1 text-sm">
                <!-- I promemoria verranno inseriti qui dinamicamente -->
            </div>
        </div>

        <div class="space-y-8">
            <!-- 1. Sezione per Aggiungere Nuove Piante -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Aggiungi una Pianta</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="new-plant-name" placeholder="Nome della nuova pianta..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                    <button id="add-plant-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors shadow-sm">
                        Aggiungi
                    </button>
                </div>
            </div>

            <!-- 2. Sezione per Registrare un'Azione -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Registra un'Azione</h2>
                <form id="action-form" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <!-- Menu a tendina per la pianta -->
                        <div class="w-full">
                            <label for="plant-select" class="block text-sm font-medium text-gray-700 mb-1">Pianta</label>
                            <select id="plant-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition">
                                <!-- Opzioni popolate dinamicamente -->
                            </select>
                        </div>
                        <!-- Menu a tendina per l'azione -->
                        <div class="w-full">
                             <label for="action-select" class="block text-sm font-medium text-gray-700 mb-1">Azione</label>
                            <select id="action-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition">
                                <option value="water">üíß Annaffiatura</option>
                                <option value="fertilize">üåø Concimazione</option>
                            </select>
                        </div>
                        <!-- Calendario per la data -->
                        <div class="w-full relative">
                            <label for="action-date" class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                            <input type="date" id="action-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition appearance-none">
                        </div>
                    </div>
                    
                    <!-- Campo opzionale per la ripetizione -->
                    <div class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg">
                        <input type="checkbox" id="repeat-checkbox" class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                        <label for="repeat-checkbox" class="text-sm text-gray-700">Ripeti ogni</label>
                        <input type="number" id="repeat-days" min="1" max="365" placeholder="7" class="w-20 p-2 border border-gray-300 rounded-lg text-sm disabled:opacity-50" disabled>
                        <span class="text-sm text-gray-700">giorni</span>
                    </div>
                    
                    <!-- Pulsante di salvataggio -->
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors shadow-sm">
                        Salva
                    </button>
                </form>
            </div>
            
            <!-- 3. Lista delle Piante Esistenti -->
            <div>
                 <h2 class="text-2xl font-semibold text-gray-800 mb-4">Le tue Piante</h2>
                 <div id="plant-list" class="space-y-4">
                    <!-- Le schede delle piante verranno inserite qui dinamicamente -->
                 </div>
            </div>
        </div>

        <!-- Elemento per le notifiche -->
        <div id="notification" class="fixed bottom-5 right-5 bg-green-500 text-white py-3 px-5 rounded-lg shadow-xl opacity-0 transform translate-y-10 transition-all duration-300">
            Messaggio di notifica
        </div>

    </div>

    <!-- Finestra Modale per le Info sulla Pianta -->
    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800">Info Pianta</h2>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            
            <!-- Sezione Intervalli -->
            <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">‚è∞ Intervalli di ripetizione</h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <label class="text-sm text-gray-600">üíß Annaffiatura ogni</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="water-interval" min="0" max="365" placeholder="0" class="w-20 p-2 border border-gray-300 rounded-lg text-sm">
                            <span class="text-sm text-gray-600">giorni</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="text-sm text-gray-600">üåø Concimazione ogni</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="fertilize-interval" min="0" max="365" placeholder="0" class="w-20 p-2 border border-gray-300 rounded-lg text-sm">
                            <span class="text-sm text-gray-600">giorni</span>
                        </div>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">Lascia 0 per disattivare il promemoria</p>
            </div>
            
            <!-- Sezione Note -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">üìù Note</label>
                <textarea id="plant-notes" class="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition" placeholder="Aggiungi note sulla pianta (es. tipo di terriccio, esposizione, ecc)..."></textarea>
            </div>
            
            <div class="flex justify-end gap-4">
                <button id="cancel-modal-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition-colors">Annulla</button>
                <button id="save-notes-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">Salva</button>
            </div>
        </div>
    </div>

    <!-- Finestra Modale di Conferma Eliminazione -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center">
            <h2 id="confirm-title" class="text-xl font-bold text-gray-800 mb-4">Sei sicuro?</h2>
            <p id="confirm-message" class="text-gray-600 mb-6">Vuoi davvero eliminare questa pianta? L'azione √® irreversibile.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition-colors">Annulla</button>
                <button id="confirm-ok-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors">Elimina</button>
            </div>
        </div>
    </div>


    <script>
        // Attendi che Firebase sia caricato
        setTimeout(() => {
            if (!window.firebaseDb || !window.firebaseOperations) {
                console.error('Firebase non configurato correttamente!');
                document.getElementById('sync-text').textContent = 'Errore: Configura Firebase!';
                document.getElementById('sync-indicator').classList.remove('text-green-600');
                document.getElementById('sync-indicator').classList.add('text-red-600');
                return;
            }

            const db = window.firebaseDb;
            const { collection, doc, setDoc, getDocs, deleteDoc, onSnapshot, updateDoc } = window.firebaseOperations;

            // Elementi del DOM
            const newPlantNameInput = document.getElementById('new-plant-name');
            const addPlantBtn = document.getElementById('add-plant-btn');
            const plantSelect = document.getElementById('plant-select');
            const actionForm = document.getElementById('action-form');
            const actionDateInput = document.getElementById('action-date');
            const plantListContainer = document.getElementById('plant-list');
            const notification = document.getElementById('notification');
            const syncText = document.getElementById('sync-text');
            const syncIndicator = document.getElementById('sync-indicator');
            
            // Elementi per ripetizione
            const repeatCheckbox = document.getElementById('repeat-checkbox');
            const repeatDaysInput = document.getElementById('repeat-days');
            const remindersSection = document.getElementById('reminders-section');
            const remindersList = document.getElementById('reminders-list');

            // Elementi della modale Info
            const infoModal = document.getElementById('info-modal');
            const modalTitle = document.getElementById('modal-title');
            const plantNotes = document.getElementById('plant-notes');
            const waterInterval = document.getElementById('water-interval');
            const fertilizeInterval = document.getElementById('fertilize-interval');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const cancelModalBtn = document.getElementById('cancel-modal-btn');
            const saveNotesBtn = document.getElementById('save-notes-btn');

            // Elementi della modale di Conferma
            const confirmModal = document.getElementById('confirm-modal');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            const confirmOkBtn = document.getElementById('confirm-ok-btn');

            // Stato dell'applicazione
            let plants = [];
            let currentPlantId = null; 
            let deleteCallback = null;

            // Gestione checkbox ripetizione
            repeatCheckbox.addEventListener('change', (e) => {
                repeatDaysInput.disabled = !e.target.checked;
                if (e.target.checked) {
                    repeatDaysInput.focus();
                    if (!repeatDaysInput.value) {
                        repeatDaysInput.value = '7'; // Default 7 giorni
                    }
                }
            });

            // --- Funzioni Firebase ---
            
            function updateSyncStatus(status) {
                if (status === 'syncing') {
                    syncText.textContent = 'Sincronizzazione...';
                    syncIndicator.classList.remove('text-green-600', 'text-red-600');
                    syncIndicator.classList.add('text-yellow-600');
                } else if (status === 'synced') {
                    syncText.textContent = 'Sincronizzato con il cloud';
                    syncIndicator.classList.remove('text-yellow-600', 'text-red-600');
                    syncIndicator.classList.add('text-green-600');
                } else if (status === 'error') {
                    syncText.textContent = 'Errore di sincronizzazione';
                    syncIndicator.classList.remove('text-green-600', 'text-yellow-600');
                    syncIndicator.classList.add('text-red-600');
                }
            }

            async function savePlantToFirebase(plant) {
                updateSyncStatus('syncing');
                try {
                    await setDoc(doc(db, 'plants', plant.id.toString()), plant);
                    updateSyncStatus('synced');
                } catch (error) {
                    console.error('Errore nel salvataggio:', error);
                    updateSyncStatus('error');
                    showNotification('Errore nel salvataggio nel cloud', true);
                }
            }

            async function deletePlantFromFirebase(plantId) {
                updateSyncStatus('syncing');
                try {
                    await deleteDoc(doc(db, 'plants', plantId.toString()));
                    updateSyncStatus('synced');
                } catch (error) {
                    console.error('Errore nell\'eliminazione:', error);
                    updateSyncStatus('error');
                }
            }

            async function updatePlantInFirebase(plant) {
                updateSyncStatus('syncing');
                try {
                    await updateDoc(doc(db, 'plants', plant.id.toString()), plant);
                    updateSyncStatus('synced');
                } catch (error) {
                    console.error('Errore nell\'aggiornamento:', error);
                    updateSyncStatus('error');
                }
            }

            // --- Funzioni per calcolare le date ---
            
            function addDays(date, days) {
                const result = new Date(date);
                result.setDate(result.getDate() + days);
                return result;
            }
            
            function daysBetween(date1, date2) {
                const oneDay = 24 * 60 * 60 * 1000;
                return Math.round((date2 - date1) / oneDay);
            }
            
            function getNextDate(lastDate, intervalDays) {
                if (!lastDate || !intervalDays) return null;
                return addDays(new Date(lastDate), intervalDays);
            }
            
            function getStatusBadge(daysUntil) {
                if (daysUntil < 0) {
                    return { text: `${Math.abs(daysUntil)} giorni fa`, class: 'status-late' };
                } else if (daysUntil === 0) {
                    return { text: 'Oggi', class: 'status-today' };
                } else if (daysUntil === 1) {
                    return { text: 'Domani', class: 'status-today' };
                } else if (daysUntil <= 3) {
                    return { text: `tra ${daysUntil} giorni`, class: 'status-soon' };
                } else {
                    return { text: `tra ${daysUntil} giorni`, class: 'status-ok' };
                }
            }

            function createGoogleCalendarLink(title, date, description) {
                const startDate = new Date(date);
                const endDate = new Date(date);
                endDate.setHours(endDate.getHours() + 1);
                
                const formatDate = (d) => d.toISOString().replace(/-|:|\.\d\d\d/g, '');
                
                const params = new URLSearchParams({
                    action: 'TEMPLATE',
                    text: title,
                    dates: `${formatDate(startDate)}/${formatDate(endDate)}`,
                    details: description || ''
                });
                
                return `https://calendar.google.com/calendar/render?${params.toString()}`;
            }

            // --- Funzioni per Promemoria ---
            
            function updateReminders() {
                const reminders = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                plants.forEach(plant => {
                    // Check annaffiatura
                    if (plant.waterInterval && plant.lastWatered) {
                        const nextWater = getNextDate(plant.lastWatered, plant.waterInterval);
                        if (nextWater) {
                            const daysUntil = daysBetween(today, nextWater);
                            if (daysUntil <= 3) {
                                reminders.push({
                                    plant: plant.name,
                                    action: 'üíß Annaffiare',
                                    date: nextWater,
                                    daysUntil: daysUntil,
                                    type: 'water'
                                });
                            }
                        }
                    }
                    
                    // Check concimazione
                    if (plant.fertilizeInterval && plant.lastFertilized) {
                        const nextFertilize = getNextDate(plant.lastFertilized, plant.fertilizeInterval);
                        if (nextFertilize) {
                            const daysUntil = daysBetween(today, nextFertilize);
                            if (daysUntil <= 3) {
                                reminders.push({
                                    plant: plant.name,
                                    action: 'üåø Concimare',
                                    date: nextFertilize,
                                    daysUntil: daysUntil,
                                    type: 'fertilize'
                                });
                            }
                        }
                    }
                });
                
                // Ordina per urgenza
                reminders.sort((a, b) => a.daysUntil - b.daysUntil);
                
                // Aggiorna UI
                if (reminders.length > 0) {
                    remindersSection.classList.remove('hidden');
                    remindersList.innerHTML = reminders.map(r => {
                        const status = getStatusBadge(r.daysUntil);
                        const calendarLink = createGoogleCalendarLink(
                            `${r.action} ${r.plant}`,
                            r.date,
                            `Promemoria per ${r.action.toLowerCase()} ${r.plant}`
                        );
                        return `
                            <div class="flex items-center justify-between p-2 hover:bg-yellow-100 rounded">
                                <span class="text-gray-700">
                                    <strong>${r.plant}</strong>: ${r.action}
                                    <span class="status-badge ${status.class} ml-2">${status.text}</span>
                                </span>
                                <a href="${calendarLink}" target="_blank" class="text-blue-600 hover:text-blue-800" title="Aggiungi a Google Calendar">
                                    üìÖ
                                </a>
                            </div>
                        `;
                    }).join('');
                } else {
                    remindersSection.classList.add('hidden');
                }
            }

            // --- Funzioni Principali ---

            function showNotification(message, isError = false) {
                notification.textContent = message;
                notification.classList.remove('bg-green-500', 'bg-red-500', 'opacity-0', 'translate-y-10');
                notification.classList.add(isError ? 'bg-red-500' : 'bg-green-500', 'opacity-100', 'translate-y-0');

                setTimeout(() => {
                    notification.classList.remove('opacity-100', 'translate-y-0');
                    notification.classList.add('opacity-0', 'translate-y-10');
                }, 3000);
            }

            function render() {
                renderPlantList();
                updatePlantDropdown();
                updateReminders();
            }

            function renderPlantList() {
                plantListContainer.innerHTML = '';
                if (plants.length === 0) {
                    plantListContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-md text-center text-gray-500">
                        <p>Non hai ancora aggiunto nessuna pianta.</p>
                        <p>Usa il modulo in alto per iniziare!</p>
                    </div>`;
                    return;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                plants.forEach(plant => {
                    const plantCard = document.createElement('div');
                    plantCard.className = 'bg-white p-5 rounded-xl shadow-md';
                    
                    let waterInfo = 'N/D';
                    let fertilizeInfo = 'N/D';
                    let waterCalendarLink = '';
                    let fertilizeCalendarLink = '';
                    
                    if (plant.lastWatered) {
                        const lastWateredDate = new Date(plant.lastWatered).toLocaleDateString('it-IT');
                        waterInfo = lastWateredDate;
                        
                        if (plant.waterInterval) {
                            const nextWater = getNextDate(plant.lastWatered, plant.waterInterval);
                            if (nextWater) {
                                const daysUntil = daysBetween(today, nextWater);
                                const status = getStatusBadge(daysUntil);
                                waterInfo += ` ‚Üí <span class="status-badge ${status.class}">${status.text}</span>`;
                                if (daysUntil <= 7) {
                                    waterCalendarLink = createGoogleCalendarLink(
                                        `üíß Annaffiare ${plant.name}`,
                                        nextWater,
                                        `Promemoria per annaffiare ${plant.name}`
                                    );
                                }
                            }
                        }
                    }
                    
                    if (plant.lastFertilized) {
                        const lastFertilizedDate = new Date(plant.lastFertilized).toLocaleDateString('it-IT');
                        fertilizeInfo = lastFertilizedDate;
                        
                        if (plant.fertilizeInterval) {
                            const nextFertilize = getNextDate(plant.lastFertilized, plant.fertilizeInterval);
                            if (nextFertilize) {
                                const daysUntil = daysBetween(today, nextFertilize);
                                const status = getStatusBadge(daysUntil);
                                fertilizeInfo += ` ‚Üí <span class="status-badge ${status.class}">${status.text}</span>`;
                                if (daysUntil <= 7) {
                                    fertilizeCalendarLink = createGoogleCalendarLink(
                                        `üåø Concimare ${plant.name}`,
                                        nextFertilize,
                                        `Promemoria per concimare ${plant.name}`
                                    );
                                }
                            }
                        }
                    }

                    plantCard.innerHTML = `
                        <div class="flex items-start justify-between gap-4 flex-wrap">
                            <div class="flex-grow">
                                <h3 class="text-xl font-bold text-gray-800 mb-3">${plant.name}</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center justify-between">
                                        <span class="text-gray-600">üíß Annaffiatura: <strong>${waterInfo}</strong></span>
                                        ${waterCalendarLink ? `<a href="${waterCalendarLink}" target="_blank" class="text-blue-600 hover:text-blue-800 ml-2" title="Aggiungi a Calendar">üìÖ</a>` : ''}
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-gray-600">üåø Concimazione: <strong>${fertilizeInfo}</strong></span>
                                        ${fertilizeCalendarLink ? `<a href="${fertilizeCalendarLink}" target="_blank"